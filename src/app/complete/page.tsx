'use client';

import Image from 'next/image';
import { motion } from 'framer-motion';
import Link from 'next/link';
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import { useEffect, useState } from 'react';
import dynamic from 'next/dynamic';
import { STAMPS } from '@/lib/stamps';

const Lottie = dynamic(() => import('lottie-react'), { ssr: false });

export default function CompletePage() {
  const supabase = createClientComponentClient();
  const [fireworks, setFireworks] = useState(null);
  const [collectedStamps, setCollectedStamps] = useState<number[]>([]);
  const [isExchanged, setIsExchanged] = useState<boolean>(() => {
    try {
      const exchanged = localStorage.getItem('isExchanged');
      return exchanged === 'true';
    } catch {
      return false;
    }
  });
  const [isLoading, setIsLoading] = useState(false);
  const [showFireworks, setShowFireworks] = useState(true);
  const [showConfirmation, setShowConfirmation] = useState(false);
  const [userId, setUserId] = useState<string | null>(null);

  // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Å®„Çπ„Çø„É≥„ÉóÁä∂ÊÖã„ÇíË™≠„ÅøËæº„Åø
  useEffect(() => {
    const loadUserAndStamps = async () => {
      try {
        // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±ÂèñÂæó
        const {
          data: { user },
        } = await supabase.auth.getUser();
        if (!user) return;

        setUserId(user.id);

        // user_stamps„ÉÜ„Éº„Éñ„É´„Åã„Çâ„Çπ„Çø„É≥„Éó„ÇíÂèñÂæó
        const { data: stampData } = await supabase.from('user_stamps').select('stamps').eq('user_id', user.id).single();

        if (stampData?.stamps) {
          setCollectedStamps(stampData.stamps);
        }

        // „É¶„Éº„Ç∂„Éº„ÅÆ„Ç≥„É≥„Éó„É™„Éº„ÉàÁä∂ÊÖã„ÇíÁ¢∫Ë™ç
        const { data: userData } = await supabase.from('users').select('completed').eq('id', user.id).maybeSingle();

        if (userData?.completed) {
          setIsExchanged(userData.completed);
          localStorage.setItem('isExchanged', userData.completed.toString());
        }
      } catch (error) {
        console.error('„É¶„Éº„Ç∂„Éº„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
      }
    };

    loadUserAndStamps();
  }, [supabase]);

  const handleExchange = () => {
    setShowConfirmation(true);
  };

  const confirmExchange = async () => {
    if (!userId) {
      console.error('„É¶„Éº„Ç∂„ÉºID„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
      setShowConfirmation(false);
      return;
    }

    try {
      setShowConfirmation(false);
      setIsLoading(true);

      // users„ÉÜ„Éº„Éñ„É´„ÅÆ„É¨„Ç≥„Éº„Éâ„ÇíÁ¢∫Ë™ç
      const { data: userData } = await supabase.from('users').select('id').eq('id', userId).maybeSingle();

      if (userData) {
        // „É¨„Ç≥„Éº„Éâ„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅØÊõ¥Êñ∞
        const { error } = await supabase.from('users').update({ completed: true }).eq('id', userId);

        if (error) throw error;
      } else {
        // „É¨„Ç≥„Éº„Éâ„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ‰ΩúÊàê
        const { error } = await supabase.from('users').insert({ id: userId, completed: true });

        if (error) throw error;
      }

      setIsExchanged(true);
      localStorage.setItem('isExchanged', 'true');
    } catch (error) {
      console.error('ÊôØÂìÅ‰∫§Êèõ„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞„Ç®„É©„Éº:', error);
    } finally {
      setIsLoading(false);
    }
  };

  // Ëä±ÁÅ´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Áî®Lottie„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
  useEffect(() => {
    fetch('/lottie/hanabi.json')
      .then((res) => res.json())
      .then((data) => setFireworks(data))
      .catch((e) => console.error('Lottie JSON Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e));
  }, []);

  // Ëä±ÁÅ´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅÆ„Çø„Ç§„Éû„Éº
  useEffect(() => {
    if (fireworks) {
      const timer = setTimeout(() => setShowFireworks(false), 4500);
      return () => clearTimeout(timer);
    }
  }, [fireworks]);

  // „Ç≥„É≥„Éó„É™„Éº„ÉàÁîªÂÉè„ÅÆ‰øùÂ≠ò/ÂÖ±Êúâ
  const handleDownload = async () => {
    try {
      const imagePath = '/images/complete_image.JPG';
      const res = await fetch(imagePath);
      const blob = await res.blob();
      const file = new File([blob], 'meitetsu_rally_complete.jpg', { type: blob.type });
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({ files: [file], title: '„ÇÅ„ÅÑ„Å¶„Å§ÁÄ¨Êà∏Á∑ö „Çπ„Çø„É≥„Éó„É©„É™„Éº„Ç≥„É≥„Éó„É™„Éº„Éà' });
      } else {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = file.name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      }
    } catch (e: unknown) {
      if (e instanceof Error && e.name !== 'AbortError') {
        console.error('Complete image save error:', e);
      }
    }
  };

  // „Çπ„Çø„É≥„Éó„ÅÆ‰øùÂ≠ò/ÂÖ±Êúâ
  const handleSaveStamp = async (stamp: (typeof STAMPS)[number]) => {
    try {
      const res = await fetch(stamp.image);
      const blob = await res.blob();
      const file = new File([blob], `stamp_${stamp.name}.jpg`, { type: blob.type });
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({ files: [file], title: stamp.name });
      } else {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = file.name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      }
    } catch (e: unknown) {
      if (e instanceof Error && e.name !== 'AbortError') {
        console.error('Stamp save error:', e);
      }
    }
  };

  return (
    <div className='min-h-screen bg-white flex flex-col items-center justify-center p-4 relative'>
      <div className='w-full max-w-md mx-auto sm:max-w-lg md:max-w-2xl lg:max-w-3xl relative'>
        {showFireworks && fireworks ? (
          <div className='fixed inset-0 flex items-center justify-center bg-white z-50'>
            <Lottie animationData={fireworks} loop autoPlay style={{ width: '100%', height: '100%' }} />
            <div className='absolute inset-0 flex items-center justify-center'>
              <Image
                src='/images/logo.png'
                alt='logo'
                width={180}
                height={120}
                className='object-contain'
                style={{
                  animation: 'zoom-in 4.5s ease-out forwards',
                }}
              />
              <style jsx global>{`
                @keyframes zoom-in {
                  from {
                    transform: scale(0);
                  }
                  to {
                    transform: scale(1);
                    width: 100%;
                  }
                }
              `}</style>
            </div>
          </div>
        ) : (
          <>
            <header className='w-full py-4 px-6 flex justify-center items-center bg-white shadow-md rounded-b-3xl fixed top-0 left-0 right-0 z-10'>
              <div className='w-full max-w-md mx-auto sm:max-w-lg md:max-w-2xl lg:max-w-3xl relative'>
                <Image src='/images/logo.png' alt='logo' width={180} height={120} className='object-contain hover:scale-100 transition-transform' />
              </div>
            </header>

            <main className='relative flex flex-col items-center justify-center gap-2 mt-24 mb-8'>
              <div className='flex items-center w-full mb-4'>
                <motion.div
                  className='mr-3'
                  animate={{
                    y: [0, -2, 0, 2, 0],
                    rotate: [-1, 1, -1],
                  }}
                  transition={{
                    repeat: Infinity,
                    duration: 2,
                    ease: 'easeInOut',
                  }}>
                  <Image src='/images/densha.jpg' alt='ÈõªËªä' width={48} height={48} className='object-contain' />
                </motion.div>
                <div className='flex flex-col'>
                  <div className='text-gray-600 text-xl font-bold relative z-0'>
                    <span className='relative inline-block'>„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô üéâ</span>
                  </div>
                  <p className='text-gray-600 text-sm'>„Ç≥„É≥„Éó„É™„Éº„ÉàË®òÂøµÁîªÂÉè„ÅØ„Åì„Å°„Çâ„Åß„Åôüëá</p>
                </div>
              </div>

              <motion.div
                initial={{ scale: 0.8, opacity: 0 }}
                animate={{ scale: 1, opacity: 1 }}
                transition={{ duration: 0.8, delay: 0.3 }}
                className='relative overflow-hidden transform-gpu hover:shadow-3xl transition-all'
                style={{
                  perspective: '1000px',
                  transformStyle: 'preserve-3d',
                }}>
                <div
                  className='p-2 bg-gradient-to-r from-amber-100 to-amber-200 border-8 border-amber-700 rounded-lg'
                  style={{
                    boxShadow: '0 10px 25px rgba(0,0,0,0.2), 0 10px 10px rgba(0,0,0,0.15)',
                    transform: 'rotateX(5deg)',
                    transformStyle: 'preserve-3d',
                  }}>
                  <div className='p-2 relative' style={{ transform: 'translateZ(20px)' }}>
                    <Image
                      src='/images/complete_image.JPG'
                      alt='complete'
                      width={800}
                      height={600}
                      className='object-contain rounded-md'
                      style={{
                        boxShadow: '0 5px 15px rgba(0,0,0,0.1)',
                        transform: 'translateZ(10px)',
                      }}
                    />
                  </div>
                  <div
                    className='absolute -bottom-2 left-1/2 transform -translate-x-1/2 w-16 h-4 bg-amber-800 rounded-t-lg'
                    style={{ transform: 'translateZ(5px) translateX(-50%)' }}></div>
                </div>
              </motion.div>

              <div className='flex mt-4 gap-4 flex-wrap justify-center'>
                <button
                  onClick={handleDownload}
                  className='px-8 py-3 bg-green-500 text-white text-lg rounded-full shadow-lg transition-all hover:shadow-xl active:scale-95 flex items-center gap-2'
                  style={{ backgroundColor: '#004ea2' }}>
                  <DownloadIcon />
                  „Ç≥„É≥„Éó„É™„Éº„ÉàÁîªÂÉè„Çí‰øùÂ≠ò
                </button>
              </div>

              <div className='flex-1 w-full p-4 my-6 bg-gray-100 shadow-lg rounded-lg gap-2'>
                <p className='w-full text-sm font-bold text-gray-600'>„Ç≥„É≥„Éó„É™„Éº„Éà„Ç´„Éº„ÉâÂèó„ÅëÂèñ„ÇäÊñπÊ≥ï</p>
                <p className='w-full text-xs mt-4 text-gray-600'>
                  Â∞æÂºµÁÄ¨Êà∏ÈßÖÂá∫Êú≠Á™ìÂè£„Åß„ÄÅË®òÂøµ‰πóËªäÂà∏„Å´ ‰ªòÂ±û„Åó„Å¶„ÅÑ„Çã„Ç≥„É≥„Éó„É™„Éº„Éà„Ç´„Éº„ÉâÂºïÊèõÂà∏„Å®„ÄÅ „Åì„ÅÆÁîªÈù¢„Çí‰∏ÄÁ∑í„Å´ÊèêÁ§∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                </p>
              </div>

              <div className='flex-1 w-full p-4 my-6 bg-gray-100 shadow-lg rounded-lg gap-2'>
                <p className='w-full text-sm text-gray-600'>‚Üì‰øÇÂì°Áî® ‰∫§ÊèõÁ¢∫Ë™ç„Éú„Çø„É≥</p>
                <p className='w-full text-xs mt-4 text-gray-600'>„ÅäÂÆ¢„Åï„ÅæËá™Ë∫´„ÅßÊìç‰Ωú„Åó„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                <button
                  onClick={handleExchange}
                  disabled={isExchanged || isLoading}
                  className={`mt-4 px-8 py-3 rounded-full shadow-lg transition-all hover:shadow-xl active:scale-95 flex items-center gap-2 ${
                    isExchanged ? 'bg-gray-400 cursor-not-allowed' : isLoading ? 'bg-yellow-500 cursor-wait' : 'bg-red-500 hover:bg-red-600'
                  } text-white`}>
                  {isLoading ? <span>Âá¶ÁêÜ‰∏≠...</span> : isExchanged ? <span>ÊôØÂìÅ‰∫§ÊèõÊ∏à„Åø</span> : <span>ÊôØÂìÅ„Å®‰∫§Êèõ„Åô„Çã</span>}
                </button>
              </div>

              <div className='flex-1 w-full my-6 gap-2'>
                <p className='text-gray-600'>
                  üéµ ÁÄ¨Êà∏Ëîµ„Éü„É•„Éº„Ç∏„Ç¢„É†„ÅÆ„ÅîÁ¥π‰ªãÂãïÁîª„Åß„Åô
                  <br />
                  „Åú„Å≤„ÅîË¶ñËÅ¥„Åè„Å†„Åï„ÅÑ
                </p>
                <div className='w-full max-w-2xl my-4 aspect-video'>
                  <iframe
                    className='w-full h-full'
                    src='https://www.youtube.com/embed/sG2qLjitPxw?autoplay=1&mute=1'
                    title='YouTube video'
                    frameBorder='0'
                    allow='autoplay; encrypted-media'
                    allowFullScreen
                  />
                </div>
              </div>

              <div className='mt-8 mb-6 shadow-lg rounded-lg p-4 w-full'>
                <h3 className='text-black text-md font-bold text-center mb-4'>‚ú® „Çπ„Çø„É≥„Éó„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥ ‚ú®</h3>
                <div className='grid grid-cols-5 gap-4 md:grid-cols-5 lg:grid-cols-10'>
                  {collectedStamps.map((id) => {
                    const stamp = STAMPS.find((s) => s.id === id);
                    if (!stamp) return null;
                    return (
                      <div
                        key={id}
                        className='flex aspect-square rounded-md overflow-hidden relative cursor-pointer'
                        onClick={() => handleSaveStamp(stamp)}>
                        <Image src={stamp.image} alt={stamp.name} width={100} height={100} className='object-cover w-full h-full' />
                      </div>
                    );
                  })}
                </div>
              </div>
              <Link
                href='/'
                className='px-8 py-3 bg-blue-500 text-white rounded-full shadow-lg hover:bg-blue-600 transition-all hover:shadow-xl active:scale-95 md:px-10 md:py-4 md:text-lg'>
                „Éõ„Éº„É†„Å´Êàª„Çã
              </Link>
            </main>
          </>
        )}

        {/* Á¢∫Ë™ç„Ç¢„É©„Éº„Éà */}
        {showConfirmation && (
          <div className='fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50'>
            <div className='bg-white p-6 rounded-xl shadow-xl max-w-sm w-full'>
              <h3 className='text-black text-lg font-bold mb-4'>ÊôØÂìÅ‰∫§Êèõ„ÅÆÁ¢∫Ë™ç</h3>
              <p className='mb-6 text-gray-600'>Êú¨ÂΩì„Å´„Ç≥„É≥„Éó„É™„Éº„Éà„Ç´„Éº„Éâ„Å®ÊôØÂìÅ„Çí‰∫§Êèõ„Åó„Åæ„Åô„ÅãÔºü</p>
              <div className='flex justify-end gap-3'>
                <button onClick={() => setShowConfirmation(false)} className='px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400'>
                  „Ç≠„É£„É≥„Çª„É´
                </button>
                <button onClick={confirmExchange} className='px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600'>
                  ‰∫§Êèõ„Åô„Çã
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

const DownloadIcon = () => (
  <svg className='w-5 h-5' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
    <path strokeLinecap='round' strokeLinejoin='round' strokeWidth={2} d='M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4' />
  </svg>
);
